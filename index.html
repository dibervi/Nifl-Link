<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Nifl-Link | Rituální Sněm</title>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <style>
    :root { --gold: #bd9b5d; --bg: #050505; }
    
    body, html { 
      margin: 0; padding: 0; width: 100%; height: 100%; 
      background-color: var(--bg); color: #e0e0e0; 
      font-family: "Segoe UI", sans-serif; 
      display: flex; align-items: center; justify-content: center; 
      overflow: hidden; 
    }

    #matrixCanvas { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      z-index: 0; opacity: 0.15; pointer-events: none; 
    }
    
    /* Kruh a runy */
    .stars-container { 
      position: relative; width: 85vmin; height: 85vmin; 
      display: flex; align-items: center; justify-content: center; 
      z-index: 4; 
    }

    .star { 
      position: absolute; 
      font-size: clamp(25px, 7vmin, 45px); 
      color: #1a1a1a; 
      transition: color 0.8s ease-out, transform 0.3s ease-out, filter 0.8s ease-out; 
      user-select: none;
      opacity: 0.5;
    }
    
    /* Magický efekt záření (Glow) */
    .star.glow { 
      transform: scale(1.5) translateY(-5px);
      opacity: 1 !important;
      z-index: 10;
      filter: 
        drop-shadow(0 0 5px currentColor) 
        drop-shadow(0 0 15px currentColor)
        drop-shadow(0 0 30px currentColor);
    }

    /* UI Panel */
    #ui-panel { 
      position: absolute; width: 300px; 
      background: rgba(5, 5, 5, 0.95); 
      backdrop-filter: blur(20px); 
      border: 1px solid var(--gold); 
      border-radius: 25px; padding: 40px; 
      text-align: center; z-index: 100; 
      box-shadow: 0 0 60px rgba(0,0,0,1); 
    }

    input { 
      background: transparent; border: none; 
      border-bottom: 2px solid var(--gold); 
      color: white; padding: 12px; width: 90%; 
      outline: none; margin-bottom: 25px; 
      text-align: center; font-family: monospace; 
      font-size: 20px; letter-spacing: 2px;
    }

    button { 
      background: var(--gold); border: none; 
      padding: 15px; border-radius: 30px; 
      cursor: pointer; font-weight: bold; 
      width: 100%; margin: 8px 0; 
      text-transform: uppercase; transition: 0.4s;
      letter-spacing: 1px;
    }

    button:hover { background: #fff; transform: translateY(-2px); }
    .hidden { display: none !important; }
    #status { position: fixed; bottom: 20px; font-size: 11px; color: var(--gold); letter-spacing: 3px; opacity: 0.7; }
  </style>
</head>
<body>

  <canvas id="matrixCanvas"></canvas>
  
  <div class="stars-container" id="starsContainer">
    </div>

  <div id="ui-panel">
    <h1 style="color:var(--gold); margin:0 0 20px 0; letter-spacing:6px; font-size: 22px;">NIFL-LINK</h1>
    <input type="text" id="roomInput" placeholder="NÁZEV SNĚMU" maxlength="15">
    <button id="btnCreate">Vytvořit Sněm</button>
    <button id="btnJoin">Připojit se</button>
    <p style="font-size: 10px; opacity: 0.5; margin-top: 20px;">VSTUPTE DO KRUHU</p>
  </div>

  <div id="status">ODPOJENO</div>

<script>
  // Rituální paleta: Zlato, Oheň, Polární záře, Led
  const runes = ["ᚫ", "ᚱ", "ᚷ", "ᛞ", "ᛗ", "ᛟ", "ᚹ", "ᚻ", "ᚾ", "ᛁ", "ᛃ", "ᛒ", "ᛏ", "ᛖ", "ᛚ", "ᛯ", "ᚦ", "ᚪ", "ᚳ", "ᛇ", "ᛉ", "ᛋ", "ᚠ", "ᚢ"];
  const colors = [
    '#FFD700', // Zlatá
    '#B22222', // Temně červená
    '#00FA9A', // Polární zelená
    '#40E0D0', // Tyrkysová
    '#87CEEB', // Ledově modrá
    '#DAA520', // Staré zlato
    '#FF4500'  // Oheň
  ];
  
  const myColor = colors[Math.floor(Math.random() * colors.length)];
  let myPeer, myStream, audioContext;
  let connections = [];

  // 1. Generování rituálního kruhu (24 run)
  const container = document.getElementById('starsContainer');
  for (let i = 0; i < 24; i++) {
    const r = document.createElement('div');
    r.className = 'star';
    r.textContent = runes[i];
    const angle = (i * 360 / 24 - 90) * Math.PI / 180;
    r.style.left = `calc(50% + ${Math.cos(angle)*38}vmin - 15px)`;
    r.style.top = `calc(50% + ${Math.sin(angle)*38}vmin - 15px)`;
    container.appendChild(r);
  }
  const stars = document.querySelectorAll('.star');

  // 2. Audio Analýza a odesílání hlasových pulsů
  async function startAudioAnalysis(stream, color) {
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if (audioContext.state === 'suspended') await audioContext.resume();

    const source = audioContext.createMediaStreamSource(stream);
    const analyser = audioContext.createAnalyser();
    source.connect(analyser);
    analyser.fftSize = 256;
    const data = new Uint8Array(analyser.frequencyBinCount);

    function check() {
      analyser.getByteFrequencyData(data);
      let sum = 0; for(let i=0; i<data.length; i++) sum += data[i];
      let volume = sum / data.length;

      if (volume > 15) { 
        triggerRandomRune(color);
        connections.forEach(conn => {
            if(conn.open) conn.send({type: 'speech', color: color});
        });
      }
      requestAnimationFrame(check);
    }
    check();
  }

  // Funkce pro magické rozsvícení runy
  function triggerRandomRune(color) {
    const availableStars = Array.from(stars).filter(s => !s.classList.contains('glow'));
    if (availableStars.length > 0) {
        const target = availableStars[Math.floor(Math.random() * availableStars.length)];
        target.style.color = color;
        target.classList.add('glow');

        setTimeout(() => {
            target.classList.remove('glow');
            setTimeout(() => { 
                if(!target.classList.contains('glow')) target.style.color = ''; 
            }, 800);
        }, 500);
    }
  }

  // 3. Síťová logika (PeerJS)
  const ui = document.getElementById('ui-panel');
  const statusEl = document.getElementById('status');

  async function initMedia() {
    try {
      myStream = await navigator.mediaDevices.getUserMedia({audio: true});
      ui.classList.add('hidden');
      statusEl.innerText = "SNĚM AKTIVNÍ";
      startAudioAnalysis(myStream, myColor);
    } catch(e) { alert("Vstup vyžaduje mikrofon."); }
  }

  document.getElementById('btnCreate').onclick = async () => {
    const id = document.getElementById('roomInput').value.trim().toLowerCase();
    if (id.length < 3) return alert("Název musí mít aspoň 3 znaky.");
    await initMedia();
    myPeer = new Peer(id);
    setupPeerListeners();
  };

  document.getElementById('btnJoin').onclick = async () => {
    const id = document.getElementById('roomInput').value.trim().toLowerCase();
    if (!id) return alert("Zadej název sněmu.");
    await initMedia();
    myPeer = new Peer();
    myPeer.on('open', () => {
        const conn = myPeer.connect(id);
        const call = myPeer.call(id, myStream);
        handleNewConnection(conn);
        handleCall(call);
    });
    setupPeerListeners();
  };

  function setupPeerListeners() {
    myPeer.on('connection', handleNewConnection);
    myPeer.on('call', handleCall);
    myPeer.on('error', err => { console.error(err); statusEl.innerText = "CHYBA SPOJENÍ"; });
  }

  function handleNewConnection(conn) {
    connections.push(conn);
    conn.on('data', data => {
      if (data.type === 'speech') triggerRandomRune(data.color);
    });
  }

  function handleCall(call) {
    call.answer(myStream);
    call.on('stream', remoteStream => {
      const audio = new Audio();
      audio.srcObject = remoteStream;
      audio.play();
    });
  }

  // Matrix pozadí s runami
  const canvas = document.getElementById('matrixCanvas');
  const ctx = canvas.getContext('2d');
  function initMatrix() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  }
  initMatrix(); window.onresize = initMatrix;
  let drops = Array(Math.floor(canvas.width/20)).fill(1);
  function drawMatrix() {
    ctx.fillStyle = "rgba(0, 0, 0, 0.1)"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#0a0a0a"; ctx.font = "15px monospace";
    drops.forEach((y, i) => {
      ctx.fillText(runes[Math.floor(Math.random()*runes.length)], i*20, y*20);
      if(y*20 > canvas.height && Math.random() > 0.985) drops[i] = 0;
      drops[i]++;
    });
  }
  setInterval(drawMatrix, 60);
</script>
</body>
</html>
