<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Nifl-Link | Rituální Sněm</title>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <style>
    :root { --gold: #bd9b5d; --bg: #050505; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: var(--bg); color: #e0e0e0; font-family: "Segoe UI", sans-serif; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    #matrixCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; pointer-events: none; }
    h1.main-title { position: absolute; top: 5vh; font-size: clamp(16px, 4vw, 24px); letter-spacing: 0.5em; color: #222; z-index: 6; margin: 0; text-transform: uppercase; pointer-events: none; }
    h1.main-title span { color: var(--gold); }
    .stars-container { position: relative; width: 85vmin; height: 85vmin; display: flex; align-items: center; justify-content: center; z-index: 4; }
    #centerBtn { width: 20vmin; height: 20vmin; max-width: 100px; max-height: 100px; font-size: clamp(30px, 8vmin, 50px); background: radial-gradient(circle, #bd9b5d, #8a6d3b); color: #111; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 150; box-shadow: 0 0 30px rgba(189,155,93,0.3); transition: 0.5s; outline: none; }
    #centerBtn.locked { background: #441111; color: #ff4444 !important; border: 2px solid #ff0000; box-shadow: 0 0 20px #ff0000; }
    #centerBtn.active-room { background: #111; color: var(--gold); border: 1px solid var(--gold); }
    .star { position: absolute; font-size: clamp(25px, 7vmin, 45px); color: #1a1a1a; transition: color 0.5s, transform 0.2s, filter 0.5s; user-select: none; opacity: 0.5; }
    .star.glow { transform: scale(1.2); opacity: 1 !important; z-index: 10; filter: drop-shadow(0 0 10px currentColor); }
    #ui-panel { position: absolute; width: 280px; background: rgba(5, 5, 5, 0.98); backdrop-filter: blur(20px); border: 1px solid var(--gold); border-radius: 25px; padding: 30px; text-align: center; z-index: 200; box-shadow: 0 0 100px #000; }
    input { background: transparent; border: none; border-bottom: 2px solid var(--gold); color: white; padding: 10px; width: 90%; outline: none; margin-bottom: 20px; text-align: center; font-family: monospace; font-size: 18px; }
    button.menu-btn { background: var(--gold); border: none; padding: 12px; border-radius: 25px; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; text-transform: uppercase; transition: 0.3s; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <canvas id="matrixCanvas"></canvas>
  <h1 class="main-title">NIFL-<span>LINK</span></h1>
  <div class="stars-container" id="starsContainer"><button id="centerBtn">ᛟ</button></div>
  <div id="ui-panel" class="hidden">
    <input type="text" id="roomInput" placeholder="NÁZEV SNĚMU" maxlength="15">
    <button class="menu-btn" id="btnCreate">VYTVOŘIT SNĚM</button>
    <button class="menu-btn" id="btnJoin">PŘIPOJIT SE</button>
  </div>

<script>
  const runes = ["ᚫ", "ᚱ", "ᚷ", "ᛞ", "ᛗ", "ᛟ", "ᚹ", "ᚻ", "ᚾ", "ᛁ", "ᛃ", "ᛒ"];
  const colors = ['#FFD700', '#B22222', '#00FA9A', '#40E0D0', '#87CEEB', '#DAA520', '#FF4500'];
  const myColor = colors[Math.floor(Math.random() * colors.length)];
  let myPeer, myStream, audioContext, isHost = false, isLocked = false;
  let connections = new Map();
  let lastTrigger = 0;

  const stars = [];
  const container = document.getElementById('starsContainer');
  for (let i = 0; i < 12; i++) {
    const r = document.createElement('div');
    r.className = 'star'; r.textContent = runes[i];
    const angle = (i * 360 / 12 - 90) * Math.PI / 180;
    r.style.left = `calc(50% + ${Math.cos(angle)*38}vmin - 15px)`;
    r.style.top = `calc(50% + ${Math.sin(angle)*38}vmin - 15px)`;
    container.appendChild(r);
    stars.push(r);
  }

  const centerBtn = document.getElementById('centerBtn');
  const uiPanel = document.getElementById('ui-panel');

  // Funkce pro vynucené probuzení audio kontextu (klíč k Safari/Chrome)
  async function unlockAudio() {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioContext.state === 'suspended') {
      await audioContext.resume();
    }
  }

  centerBtn.onclick = async () => {
    await unlockAudio(); // Probuzení zvuku při každém kliku

    if (myPeer) { 
      if(isHost) toggleLock(); 
      return; 
    }

    try {
      myStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
      });
      centerBtn.classList.add('hidden');
      uiPanel.classList.remove('hidden');
    } catch(e) { 
      alert("Pro vstup je nutné povolit mikrofon."); 
    }
  };

  function toggleLock() {
    isLocked = !isLocked;
    centerBtn.classList.toggle('locked', isLocked);
    centerBtn.textContent = isLocked ? "ᚦ" : "ᛟ";
  }

  document.getElementById('btnCreate').onclick = async () => {
    await unlockAudio();
    const id = document.getElementById('roomInput').value.trim().toLowerCase();
    if (id.length < 3) return;
    isHost = true;
    myPeer = new Peer(id);
    myPeer.on('open', startSession);
    myPeer.on('error', (err) => { 
      if (err.type === 'id-taken') { alert("Název už existuje!"); location.reload(); }
    });
    myPeer.on('connection', (conn) => {
      if (isLocked) {
        centerBtn.style.boxShadow = "0 0 50px #ff0000";
        setTimeout(() => centerBtn.style.boxShadow = "", 1000);
        setTimeout(() => conn.send({type: 'locked'}), 500);
        return;
      }
      const peerList = Array.from(connections.keys());
      setTimeout(() => conn.send({type: 'peer-list', peers: peerList}), 1000);
      setupConnection(conn);
    });
    myPeer.on('call', (call) => { 
      call.answer(myStream); 
      handleCall(call); 
    });
  };

  document.getElementById('btnJoin').onclick = async () => {
    await unlockAudio();
    const roomName = document.getElementById('roomInput').value.trim().toLowerCase();
    if (!roomName) return;
    myPeer = new Peer();
    myPeer.on('open', () => {
      const conn = myPeer.connect(roomName);
      setupConnection(conn);
      startSession();
    });
    myPeer.on('connection', setupConnection);
    myPeer.on('call', (call) => { 
      call.answer(myStream); 
      handleCall(call); 
    });
  };

  function startSession() {
    uiPanel.classList.add('hidden');
    centerBtn.classList.remove('hidden');
    centerBtn.classList.add('active-room');
    startAudioAnalysis();
  }

  function setupConnection(conn) {
    conn.on('open', () => connections.set(conn.peer, conn));
    conn.on('data', data => {
      if (data.type === 'speech') triggerRandomRune(data.color);
      if (data.type === 'locked') { alert("Místnost je zamčena."); location.reload(); }
      if (data.type === 'peer-list') {
        data.peers.forEach(peerId => {
          if (!connections.has(peerId)) {
            const newConn = myPeer.connect(peerId);
            setupConnection(newConn);
            myPeer.call(peerId, myStream);
          }
        });
      }
    });
    conn.on('close', () => connections.delete(conn.peer));
  }

  function handleCall(call) {
    call.on('stream', remoteStream => {
      let audio = document.getElementById('audio-' + call.peer);
      if (!audio) {
        audio = document.createElement('audio');
        audio.id = 'audio-' + call.peer;
        document.body.appendChild(audio);
      }
      audio.srcObject = remoteStream;
      audio.onloadedmetadata = () => {
        audio.play().catch(console.error);
      };
    });
  }

  function startAudioAnalysis() {
    const source = audioContext.createMediaStreamSource(myStream);
    const analyser = audioContext.createAnalyser();
    source.connect(analyser);
    analyser.fftSize = 256;
    const data = new Uint8Array(analyser.frequencyBinCount);
    const check = () => {
      analyser.getByteFrequencyData(data);
      let vol = data.reduce((a,b) => a+b) / data.length;
      if (vol > 25 && Date.now() - lastTrigger > 400) {
        triggerRandomRune(myColor);
        lastTrigger = Date.now();
        connections.forEach(c => { if(c.open) c.send({type: 'speech', color: myColor}); });
      }
      requestAnimationFrame(check);
    };
    check();
  }

  function triggerRandomRune(color) {
    const avail = stars.filter(s => !s.classList.contains('glow'));
    if (avail.length > 0) {
      const t = avail[Math.floor(Math.random() * avail.length)];
      t.style.color = color; t.classList.add('glow');
      setTimeout(() => { 
        t.classList.remove('glow'); 
        setTimeout(() => { if(!t.classList.contains('glow')) t.style.color = ''; }, 400); 
      }, 250);
    }
  }

  const canvas = document.getElementById('matrixCanvas');
  const ctx = canvas.getContext('2d');
  const initM = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
  initM(); window.onresize = initM;
  let drops = Array(Math.floor(canvas.width/20)).fill(1);
  setInterval(() => {
    ctx.fillStyle = "rgba(0,0,0,0.1)"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#0a0a0a"; ctx.font = "15px monospace";
    drops.forEach((y, i) => {
      ctx.fillText(runes[Math.floor(Math.random()*runes.length)], i*20, y*20);
      if(y*20 > canvas.height && Math.random() > 0.98) drops[i] = 0;
      drops[i]++;
    });
  }, 60);
</script>
</body>
</html>
