<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Hlasový chat – jednoduchý</title>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <style>
    body {font-family: Arial; text-align:center; padding:20px; background:#f0f0f0;}
    button {padding:12px 24px; margin:10px; font-size:18px;}
    .speaking {background:#ff4444; color:white; font-weight:bold;}
    #peers {margin:20px; font-size:18px;}
    .peer {display:inline-block; padding:8px 16px; margin:6px; background:#ddd; border-radius:20px;}
  </style>
</head>
<body>
  <h2>Hlasový chat</h2>
  
  <input id="myname" placeholder="Zadej své jméno" value="Filip">
  <button onclick="connect()">Povolit mikrofon a připojit</button>
  
  <br><br>
  <button id="talkBtn" onclick="toggleTalk()" disabled style="display:none">Mluvím teď</button>
  
  <div id="status"></div>
  <div id="peers"></div>
  
  <audio id="remoteAudios" autoplay style="display:none"></audio>

  <script>
    let myPeer, myStream, myId, myName = "";
    let peers = {};           // {id: {name, call, isTalking}}
    let isTalking = false;

    const urlParams = new URLSearchParams(window.location.search);
    myName = urlParams.get('name') || "Anonym";

    document.getElementById("myname").value = myName;

    async function connect() {
      myName = document.getElementById("myname").value.trim() || "Anonym";
      
      try {
        myStream = await navigator.mediaDevices.getUserMedia({audio:true});
        document.getElementById("status").innerText = "Připojeno! Čekám na ostatní...";
        
        myPeer = new Peer();
        
        myPeer.on('open', id => {
          myId = id;
          document.getElementById("status").innerHTML = `Tvé ID: <b>${id}</b><br>Jméno: <b>${myName}</b><br>Odkaz pro ostatní: ${location.origin + location.pathname}?name=`;
          document.getElementById("talkBtn").style.display = "inline-block";
          document.getElementById("talkBtn").disabled = false;
        });

        myPeer.on('call', call => {
          call.answer(myStream);
          handleNewPeer(call.peer, call);
        });

      } catch(e) {
        alert("Mikrofon nepovolen nebo chyba: " + e.message);
      }
    }

    function handleNewPeer(peerId, call = null) {
      if (peers[peerId]) return;
      
      peers[peerId] = {name: "?", call, isTalking: false};
      
      if (!call) {
        const outgoing = myPeer.call(peerId, myStream);
        outgoing.on('stream', () => {});
        peers[peerId].call = outgoing;
      }

      updatePeersList();
    }

    function updatePeersList() {
      const div = document.getElementById("peers");
      div.innerHTML = "<b>Připojeni:</b><br>";
      for (let id in peers) {
        let cls = peers[id].isTalking ? "peer speaking" : "peer";
        div.innerHTML += `<span class="${cls}">${peers[id].name || id.slice(0,6)}</span> `;
      }
    }

    function toggleTalk() {
      isTalking = !isTalking;
      document.getElementById("talkBtn").innerText = isTalking ? "Přestaň mluvit" : "Mluvím teď";
      document.getElementById("talkBtn").className = isTalking ? "speaking" : "";

      // Pošleme info všem (použijeme data channel – jednoduchá verze)
      Object.values(peers).forEach(p => {
        if (p.call && p.call.open) {
          p.call.peerConnection?.getDataChannels()?.[0]?.send(JSON.stringify({
            type: "talking", value: isTalking, name: myName
          }));
        }
      });
    }

    // Příjem dat (pro zobrazení jmen a mluvčího)
    myPeer?.on('connection', conn => {
      conn.on('data', data => {
        if (data.type === "talking") {
          if (peers[conn.peer]) {
            peers[conn.peer].isTalking = data.value;
            peers[conn.peer].name = data.name || peers[conn.peer].name;
            updatePeersList();
          }
        }
      });
    });

    // Automatické přidání při příchozím callu
    myPeer?.on('call', call => {
      call.answer(myStream);
      handleNewPeer(call.peer, call);
    });
  </script>
</body>
</html>
